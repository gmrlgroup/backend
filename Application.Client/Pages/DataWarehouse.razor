@page "/datawarehouse"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using System.Net.Http.Json
@using Application.Client.Components
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Data Warehouse</PageTitle>

<div class="datawarehouse-page">
    <div class="page-layout">
        <!-- Sidebar with table list -->
        <div class="sidebar @(sidebarCollapsed ? "collapsed" : "")">
            <div class="sidebar-header">
                <h2>@(sidebarCollapsed ? "DW" : "Data Warehouse")</h2>
                <button class="toggle-btn" @onclick="ToggleSidebar">
                    @(sidebarCollapsed ? "‚ñ∫" : "‚óÑ")
                </button>
            </div>

            @if (!sidebarCollapsed)
            {
                <div class="sidebar-content">
                    @if (isLoadingTables)
                    {
                        <div class="loading-section">
                            <div class="spinner"></div>
                            <p>Loading tables...</p>
                        </div>
                    }
                    else if (tables.Any())
                    {
                        <div class="search-box">
                            <input type="text" 
                                   @bind="tableSearchText" 
                                   @bind:event="oninput"
                                   placeholder="Search tables..." 
                                   class="search-input" />
                        </div>

                        <div class="table-list">
                            @foreach (var table in FilteredTables)
                            {
                                <div class="table-item @(selectedTable == table.FullName ? "selected" : "")"
                                     @onclick="@(() => SelectTable(table.FullName))">
                                    <div class="table-icon">üìä</div>
                                    <div class="table-name">
                                        <div class="schema">@table.Schema</div>
                                        <div class="name">@table.Name</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="error-section">
                            <p>‚ö†Ô∏è @errorMessage</p>
                        </div>
                    }
                    else
                    {
                        <div class="empty-section">
                            <p>No tables found</p>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Main content area -->
        <div class="main-content">
            @if (!string.IsNullOrEmpty(selectedTable))
            {
                <DataWarehouseTable 
                    TableName="@selectedTable"
                    AllColumns="@columns"
                    Data="@tableData"
                    TotalRows="@totalRows"
                    CurrentPage="@currentPage"
                    TotalPages="@totalPages"
                    PageSize="@pageSize"
                    IsLoading="@isLoadingData"
                    OnPageChanged="@OnPageChanged"
                    OnPageSizeChanged="@OnPageSizeChanged" />
            }
            else
            {
                <div class="welcome-section">
                    <div class="welcome-icon">üóÑÔ∏è</div>
                    <h1>Data Warehouse Explorer</h1>
                    <p>Select a table from the sidebar to view its data</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<TableInfo> tables = new();
    private List<TableInfo> FilteredTables => string.IsNullOrWhiteSpace(tableSearchText)
        ? tables
        : tables.Where(t => t.FullName.Contains(tableSearchText, StringComparison.OrdinalIgnoreCase) ||
                           t.Name.Contains(tableSearchText, StringComparison.OrdinalIgnoreCase) ||
                           t.Schema.Contains(tableSearchText, StringComparison.OrdinalIgnoreCase)).ToList();

    private string selectedTable = string.Empty;
    private List<DataWarehouseTable.ColumnDefinition> columns = new();
    private List<Dictionary<string, object?>> tableData = new();
    private int totalRows = 0;
    private int currentPage = 1;
    private int totalPages = 0;
    private int pageSize = 100;

    private bool isLoadingTables = false;
    private bool isLoadingData = false;
    private bool sidebarCollapsed = false;
    private string tableSearchText = string.Empty;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTablesAsync();
    }

    private async Task LoadTablesAsync()
    {
        isLoadingTables = true;
        errorMessage = string.Empty;

        try
        {
            var response = await Http.GetFromJsonAsync<List<TableInfo>>("/api/DataWarehouse/tables");
            if (response != null)
            {
                tables = response;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load tables: {ex.Message}";
            Console.WriteLine($"Error loading tables: {ex}");
        }
        finally
        {
            isLoadingTables = false;
        }
    }

    private async Task SelectTable(string tableName)
    {
        if (selectedTable == tableName) return;

        selectedTable = tableName;
        currentPage = 1;
        await LoadTableDataAsync();
    }

    private async Task LoadTableDataAsync()
    {
        if (string.IsNullOrEmpty(selectedTable)) return;

        isLoadingData = true;
        errorMessage = string.Empty;

        try
        {
            var response = await Http.GetFromJsonAsync<DataTableResult>(
                $"/api/DataWarehouse/data?tableName={Uri.EscapeDataString(selectedTable)}&page={currentPage}&pageSize={pageSize}");

            if (response != null)
            {
                columns = response.Columns.Select(c => new DataWarehouseTable.ColumnDefinition
                {
                    Name = c.Name,
                    DataType = c.DataType,
                    IsVisible = true
                }).ToList();

                tableData = response.Rows;
                totalRows = response.TotalRows;
                totalPages = response.TotalPages;
                currentPage = response.CurrentPage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load table data: {ex.Message}";
            Console.WriteLine($"Error loading table data: {ex}");
        }
        finally
        {
            isLoadingData = false;
        }
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadTableDataAsync();
    }

    private async Task OnPageSizeChanged(int newPageSize)
    {
        pageSize = newPageSize;
        currentPage = 1;
        await LoadTableDataAsync();
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
    }

    // DTOs matching the backend models
    public class TableInfo
    {
        public string Schema { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
    }

    public class DataTableResult
    {
        public List<ColumnInfo> Columns { get; set; } = new();
        public List<Dictionary<string, object?>> Rows { get; set; } = new();
        public int TotalRows { get; set; }
        public int CurrentPage { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
    }

    public class ColumnInfo
    {
        public string Name { get; set; } = string.Empty;
        public string DataType { get; set; } = string.Empty;
    }
}
